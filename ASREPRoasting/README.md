# ASREPRoasting 

## What is ASREPRoasting RU 

**ASREPRoasting** - это атака на протокол аутентификации Kerberos, которая позволяет злоумышленнику получить хеши паролей пользователей, у которых установлен атрибут "Do not require Kerberos preauthentication".
<br>

## How its work RU

**GetNPUser** - это утилита из пакета Impacket, которая используется для извлечения хешей паролей пользователей, зарегистрированных в домене Active Directory, и которые не имеют установленного атрибута "Account is sensitive and cannot be delegated".
<br>
Утилита GetNPUser использует механизм аутентификации Kerberos, который используется в сети Active Directory для проверки подлинности пользователей и предоставления доступа к различным ресурсам в сети. GetNPUser запрашивает у службы аутентификации Kerberos TGT-билеты (Ticket Granting Tickets) для выбранных пользователей, используя для этого специальный тип запроса AS-REQ.
<br>
Если пользователь не имеет установленного атрибута "Account is sensitive and cannot be delegated", то GetNPUser может запросить у службы аутентификации Kerberos хеш пароля пользователя, используя для этого тип запроса TGS-REQ. Получив хеш пароля пользователя, злоумышленник может использовать его для атаки на хэш пользователя, попытавшись подобрать его методом перебора, либо для получения доступа к другим учетным записям в системе.
<br>
GetNPUser позволяет выбрать пользователей по различным критериям, таким как имя пользователя, SID, флаги учетной записи, а также задать опции для получения более подробной информации о пользователе, такой как SID домена и список групп, в которые входит пользователь.
<br>

## What is ASREPRoasting EN 

**ASREPRoasting** - is an attack on the Kerberos authentication protocol, which allows an attacker to obtain the password hashes of users with the "Do not require Kerberos preauthentication" attribute set.
<br>

## How its work EN

**GetNPUser** - is a utility from Impacket that is used to retrieve password hashes for users who are registered in an Active Directory domain and do not have the "Account is sensitive and cannot be delegated" attribute set.
<br>
The GetNPUser utility uses the Kerberos authentication mechanism, which is used in the Active Directory network to authenticate users and grant access to various resources on the network. GetNPUser requests TGT (Ticket Granting Tickets) tickets for selected users from the Kerberos authentication service using a special type of request, AS-REQ.
<br>
If the user does not have the "Account is sensitive and cannot be delegated" attribute set, GetNPUser can request the Kerberos authentication service for the user's password hash using the TGS-REQ request type. Having received the user's password hash, an intruder can use it to attack the user's hash by trying to brute force it, or to gain access to other accounts on the system.
<br>
GetNPUser allows you to select users by various criteria, such as username, SID, account flags, and set options to get more detailed information about the user, such as domain SID and list of groups the user belongs to.
<br>

## ASREPRoasting Explotation Linux 

Impacket
```
sudo impacket-GetNPUsers DOMAIN/username -request -format hashcat -outfile asreproast.hashes
sudo impacket-GetNPUsers DOMAIN/ -no-pass -usersfile users.txt
```

Cracking hash
```
hashcat -m 18200 --force -a 0 asreproast.hashes /usr/share/wordlist/rockyou.txt
```
## ASREPRoasting Explotation Windows

With Rubeus 
```
.\Rubeus.exe asreproast /format:hashcat /outfile:asreproast.hases
```

With ASREPRoast.ps1
```
Import-Module .\ASREPRoast.ps1
Invoke-ASREPRoast
Get-ASREPHash
```

## How to prevent 

**RU**
Лучший способ блокировать атаки AS-REP Roasting - найти все учетные записи пользователей, для которых не требуется предварительная аутентификация Kerberos, а затем включить эту настройку.Для дополнительной защиты можно сделать это:
<ol>
<li>Использование паролей с длиной более 14 символов: это позволит усложнить задачу злоумышленнику в переборе паролей и уменьшит вероятность успешной атаки.</li>
<li>Ограничение доступа к доменному контроллеру: злоумышленники, использующие атаку ASREPRoasting, обычно направляют свои запросы на доменные контроллеры, поэтому ограничение доступа к контроллерам может значительно уменьшить риски атаки.</li>
</ol>
<ol>
<li>https://techcommunity.microsoft.com/t5/security-compliance-and-identity/helping-protect-against-as-rep-roasting-with-microsoft-defender/ba-p/2244089</li>
</ol>

**EN**
The best way to block AS-REP Roasting attacks is to find all user accounts that do not require Kerberos pre-authentication and then enable this setting:
<ol>
<li>Using passwords longer than 14 characters: this will make it harder for attackers to guess passwords and reduce the probability of a successful attack.</li>
<li>Restrict access to the domain controller: Attackers using the ASREPRoasting attack usually direct their requests to domain controllers, so restricting access to controllers can significantly reduce the risks of the attack</li>
</ol>
<ol>
<li>https://techcommunity.microsoft.com/t5/security-compliance-and-identity/helping-protect-against-as-rep-roasting-with-microsoft-defender/ba-p/2244089</li>
</ol>